# 5.1 Groupchat User Management

## Overview

HAWKI's GroupChat feature implements a sophisticated user management system that handles room memberships, invitations, removals, and re-invitations. The system uses a dual-flag approach with `isMember` and `isRemoved` columns in the `members` pivot table to track user states.

## Member Status Matrix

The combination of `isMember` and `isRemoved` flags determines the exact state of a user's relationship with a room:

| Status | isMember | isRemoved | Description | Visible in UI |
|--------|----------|-----------|-------------|---------------|
| **Not Invited** | - | - | No entry in `members` table | No |
| **Invited (Pending)** | 0 | 0 | User received invitation but hasn't joined yet | Yes (as invitation) |
| **Active Member** | 1 | 0 | User is an active member of the room | Yes (normal room) |
| **Left Room** | 0 | 1 | User voluntarily left the room | No |
| **Removed (Pending Confirmation)** | 1 | 1 | Admin removed user, awaiting user acknowledgment | Yes (with removal badge) |
| **Removed (Confirmed)** | 0 | 1 | User acknowledged removal and left the room | No |
| **Re-invited** | 1 | 0 | Previously removed/left user was invited again | Yes (as new invitation) |

## Role-based Permissions

HAWKI's GroupChat implements a hierarchical role-based permission system with three distinct roles: Admin, Editor, and Viewer.

### Permission Matrix

| Permission | Admin | Editor | Viewer | Description |
|-----------|-------|--------|--------|-------------|
| **Read Messages** | âœ… | âœ… | âœ… | All members can read messages in the room |
| **Send Messages** | âœ… | âœ… | âŒ | Admins and Editors can send messages, Viewers are read-only |
| **Modify Room Settings** | âœ… | âŒ | âŒ | Only Admins can change room name, icon, description |
| **Edit System Prompt** | âœ… | âŒ | âŒ | Only Admins can modify AI system prompt |
| **Edit Description** | âœ… | âŒ | âŒ | Only Admins can update room description |
| **Upload/Remove Avatar** | âœ… | âŒ | âŒ | Only Admins can change room avatar image |
| **Invite Members** | âœ… | âŒ | âŒ | Only Admins can add new members to the room |
| **Assign Admin Role** | âœ… | âŒ | âŒ | Only Admins can create other Admins |
| **Assign Editor Role** | âœ… | âŒ | âŒ | Only Admins can assign Editor role |
| **Assign Viewer Role** | âœ… | âŒ | âŒ | Only Admins can assign Viewer role |
| **Remove Members** | âœ… | âŒ | âŒ | Only Admins can kick members from room |
| **Delete Room** | âœ… | âŒ | âŒ | Only Admins can permanently delete room |
| **View All Members** | âœ… | âœ… | âŒ | Viewers see only Admins + themselves |

### Role Descriptions

**Admin:**
- Full control over the room
- Can perform all actions including member management and room deletion
- Can assign any role to new or existing members
- Can modify all room settings and content
- Typically the room creator or designated moderators

**Editor:**
- Can read and send messages
- Can view all room members
- **Cannot** modify room settings or system prompt
- **Cannot** invite or remove members
- **Cannot** delete the room
- Ideal for active participants who contribute content but don't manage the room

**Viewer:**
- **Read-only access** to messages
- **Cannot** send messages or modify any content
- Can only see Admin members and themselves in the member list
- Other members are shown as "+n weitere" placeholder
- Cannot modify room settings or manage members
- Suitable for observers, auditors, or restricted access scenarios

### Member Visibility for Viewers

Viewers have restricted visibility of room members for privacy and security:

**What Viewers See:**
- All Admin members (for support/moderation contact)
- Their own profile
- Placeholder showing count of hidden members: "+n weitere Mitglieder"

**What Viewers Don't See:**
- Other Editors
- Other Viewers
- Pending invitations

**Implementation:**
```php
// Backend filters members for Viewers
if (!$membership->canViewAllMembers()) {
    $members = $members->filter(function ($member) {
        return $member->role === 'admin' || $member->user_id === Auth::id();
    });
}
```

**Frontend Display:**
```javascript
// Show placeholder for hidden members
if (roomData.can_view_all_members === false) {
    const hiddenCount = roomData.total_members_count - roomData.members.length;
    // Display: "+5 weitere Mitglieder"
}
```

### Permission Implementation

**Member Model Methods:**
```php
// Role checks
public function isAdmin(): bool
public function isEditor(): bool
public function isViewer(): bool

// Permission checks
public function canSendMessages(): bool      // Admin || Editor
public function canModifyRoom(): bool        // Admin only
public function canAddMembers(): bool        // Admin only
public function canRemoveMembers(): bool     // Admin only
public function canDeleteRoom(): bool        // Admin only
public function canViewAllMembers(): bool    // Admin || Editor
```

**Room Model Methods:**
```php
// Get member for permission checks
public function getMemberByUserId($userId): ?Member

// User-specific permission checks
public function userCanSendMessages($userId): bool
public function userCanModifyRoom($userId): bool
public function userCanAddMembers($userId): bool
public function userCanRemoveMembers($userId): bool
public function userCanDeleteRoom($userId): bool
public function userCanViewAllMembers($userId): bool
```

### Controller Permission Enforcement

All protected endpoints verify permissions before executing actions:

```php
// Example: Send message (Admin or Editor only)
public function sendMessage(Request $request, $slug): JsonResponse
{
    $room = Room::where('slug', $slug)->firstOrFail();
    
    if (!$room->userCanSendMessages(Auth::id())) {
        return response()->json([
            'success' => false,
            'message' => 'You do not have permission to send messages.'
        ], 403);
    }
    
    // Proceed with sending message...
}
```

**Protected Endpoints:**
- `sendMessage()` - Requires: Admin or Editor
- `update()` - Requires: Admin only
- `uploadAvatar()` - Requires: Admin only
- `removeAvatar()` - Requires: Admin only
- `addMember()` - Requires: Admin only
- `kickMember()` - Requires: Admin only
- `delete()` - Requires: Admin only

### Frontend UI Restrictions

**Role-based Element Visibility:**
```javascript
function applyRoleBasedUI(role) {
    // Hide admin-only elements for non-admins
    document.querySelectorAll('.admin-only').forEach(el => {
        el.style.display = (role === 'admin') ? '' : 'none';
    });
    
    // Hide editor-only elements for viewers
    document.querySelectorAll('.editor-only').forEach(el => {
        el.style.display = (role !== 'viewer') ? '' : 'none';
    });
}
```

**Input Field Restrictions:**
```javascript
// Disable message input for Viewers
if (roomData.role === 'viewer') {
    inputField.setAttribute('contenteditable', 'false');
    inputField.style.opacity = '0.5';
    inputField.setAttribute('placeholder', 
        'Nur Admins und Editors dÃ¼rfen Nachrichten senden');
}
```

**Member List Restrictions:**
```javascript
// Show member count placeholder for Viewers
if (!roomData.can_view_all_members) {
    const hiddenCount = roomData.total_members_count - visibleCount;
    showPlaceholder(`+${hiddenCount}`);
}
```

### Role Assignment Rules

**When inviting new members:**

1. **Admins can assign:**
   - Admin role
   - Editor role
   - Viewer role

2. **Editors cannot invite members**
   - No invitation permissions

3. **Viewers cannot invite members**
   - No invitation permissions

**Implementation:**
```php
// In addMember() controller method
if (!$room->userCanAddMembers(Auth::id())) {
    return response()->json([
        'success' => false,
        'message' => 'Only Admins can invite members.'
    ], 403);
}
```

### Security Considerations

1. **Privilege Escalation Prevention:**
   - Only Admins can assign any role
   - Editors and Viewers have no role assignment capabilities
   - Clear role hierarchy prevents unauthorized access

2. **Data Privacy:**
   - Viewers cannot see full member list
   - Member information restricted based on role
   - Prevents social engineering attacks

3. **Permission Inheritance:**
   - Higher roles don't automatically include lower role permissions
   - Each permission explicitly checked
   - No "skip level" permissions

4. **Audit Trail:**
   - All role assignments logged
   - Member actions traceable to specific user
   - Permission changes broadcast for transparency

5. **Read-Only Enforcement:**
   - Viewers blocked at both frontend and backend
   - Input fields disabled in UI
   - API endpoints reject unauthorized requests
   - Prevents accidental or malicious content modification

6. **Default Role:**
   - New invitations must specify role explicitly
   - No automatic Admin assignment
   - Recommended default: Viewer (least privilege principle)

### UI/UX Considerations

**For Viewers:**
- Clear visual indicators of read-only status
- Disabled input field with explanatory placeholder
- Simplified member list showing only relevant contacts
- No confusing action buttons (no edit, no invite, no remove)

**For Editors:**
- Can send messages and participate actively
- Full member visibility for collaboration
- Cannot accidentally modify room settings
- Clear distinction from Admin capabilities

**For Admins:**
- All controls visible and accessible
- Clear ownership and responsibility
- Full transparency of room state and members

## Database Schema

### Members Table Structure

```sql
members (
    id,
    room_id,
    user_id,
    role,              -- 'admin', 'editor', 'viewer', 'assistant'
    last_read,         -- timestamp of last read message
    isMember BOOLEAN,  -- true if user is currently a member
    isRemoved BOOLEAN, -- true if user was removed/left
    created_at,
    updated_at
)
```

### Key Relationships

**User Model:**
```php
// Active members only (not removed)
public function rooms() {
    return $this->belongsToMany(Room::class, 'members')
        ->wherePivot('isMember', true)
        ->wherePivot('isRemoved', false);
}

// Active members including those pending removal confirmation
public function roomsIncludingRemoved() {
    return $this->belongsToMany(Room::class, 'members')
        ->wherePivot('isMember', true);
}
```

**Room Model:**
```php
// Active members
public function members() {
    return $this->hasMany(Member::class)
        ->where('isMember', true);
}

// Former members (left or removed)
public function oldMembers() {
    return $this->hasMany(Member::class)
        ->where('isMember', false);
}

// All members (no filtering)
public function membersAll() {
    return $this->hasMany(Member::class);
}
```

## User Management Workflows

### 1. Inviting a New User

**Process:**
1. Admin invites user via email/username
2. System creates `Invitation` record
3. When user accepts: `Member` record created with `isMember=1, isRemoved=0`
4. Invitation record is deleted

**Code:**
```php
$room->addMember($userId, $role);
// Creates new member or reactivates old membership
```

### 2. User Joins Room (Accepts Invitation)

**Frontend Flow:**
- User sees invitation in room list (red badge)
- Clicks room â†’ Invitation modal appears
- Accepts â†’ Room becomes accessible
- Declines â†’ Invitation removed

**Backend:**
- Deletes invitation record
- Ensures member record exists with correct status

### 3. Admin Removes User

**Two-Phase Removal Process:**

**Phase 1: Soft Removal (Admin Action)**
```php
// In RoomService->kick()
$member->update([
    'isMember' => true,  // Still member (for UI feedback)
    'isRemoved' => true  // Marked as removed
]);

// Broadcast to removed user
event(new RoomMemberRemovedEvent($slug, $username, $room_name));
```

**User Experience:**
- Receives real-time notification
- Red badge appears on room in list
- Sidebar badge shows removal notification
- Burger menu button hidden

**Phase 2: Hard Removal (User Acknowledgment)**
```php
// User clicks "Leave Room" in removal modal
$member->update([
    'isMember' => false, // No longer a member
    'isRemoved' => true  // Removal confirmed
]);
```

**Why Two Phases?**
- Ensures user sees removal notification
- Prevents confusion (room suddenly disappearing)
- Maintains data integrity
- Allows for audit trail

### 4. User Leaves Room Voluntarily

**Process:**
```php
// In RoomService->leave()
$member->update([
    'isMember' => false,
    'isRemoved' => true
]);
```

**Result:** Same final state as confirmed removal (`isMember=0, isRemoved=1`)

### 5. Re-inviting Previously Removed User

**Smart Re-invitation Logic:**
```php
// In Room->addMember()
if ($this->isOldMember($userId)) {
    // Reactivate existing member record
    $member->recreateMembership();
    // Sets: isMember=true, isRemoved=false
}
```

**Benefits:**
- Preserves historical data
- Reuses existing member record
- Automatically resets status to "invited"
- User sees as new invitation

## UI/UX Behavior

### Badge System

**Chat List Badges (per room):**
- ðŸ”´ Red Badge: New invitation OR removed from room
- ðŸŸ¢ Green Badge: Unread messages

**Sidebar Badge (GroupChat icon):**
- ðŸ”´ Red: Has invitations OR removed rooms
- ðŸŸ¢ Green: Has unread messages (no invitations/removals)
- ðŸ”´ðŸŸ¢ Both: Has invitations/removals AND unread messages

**Priority:** Removed/Invitation > Unread Messages

### Burger Menu Visibility

**For Different Room States:**
- **Active Room:** Shows "Leave", "Info", "Mark as Read" (if unread)
- **New Invitation:** Shows "Decline" only
- **Removed Room:** Burger menu hidden (only click opens modal)

### Modal Types

**1. Invitation Modal**
- Shown when clicking on invited room
- Options: "Accept", "Decline"
- Triggered by: `room.isNewRoom === true`

**2. Removal Modal**
- Shown when clicking on removed room
- Message: "You have been removed from this room"
- Button: "Leave Room" (confirms removal)
- Triggered by: `room.isRemoved === true`

**3. Leave Confirmation Modal**
- Shown when user voluntarily leaves
- Accessed via: Burger menu â†’ "Leave Room"
- Only for active members

## Real-time Updates

### WebSocket Events

**RoomMemberRemovedEvent:**
```javascript
{
    room_slug: 'room-unique-slug',
    room_name: 'Room Display Name',
    username: 'removed-username'
}
```

**Client-side Handling:**
1. Receives event for specific user
2. Marks room as removed in local state
3. Displays red badge immediately
4. Hides burger menu button
5. Updates sidebar badge
6. Closes room if currently viewing

### Event Broadcasting

**Server-side:**
```php
event(new RoomMemberRemovedEvent(
    $slug, 
    $user->username, 
    $room->room_name
));
```

**Client-side Listener:**
```javascript
Echo.private(`user.${userId}`)
    .listen('RoomMemberRemovedEvent', (e) => {
        const room = rooms.find(r => r.slug === e.room_slug);
        room.isRemoved = true;
        // Update UI...
    });
```

## API Endpoints

### Room Management

**Leave Room:**
```http
DELETE /req/room/leaveRoom/{slug}
```
- Used for both voluntary leave and removal confirmation
- Sets `isMember=0, isRemoved=1`
- Deletes room if only one member left

**Kick Member:**
```http
DELETE /req/room/removeMember/{slug}
```
- Admin-only action
- Requires permission check
- Sets `isMember=1, isRemoved=1` (soft removal)
- Broadcasts `RoomMemberRemovedEvent`

**Add Member:**
```http
POST /req/room/addMember/{slug}
```
- Handles new invitations and re-invitations
- Smart logic: creates new or reactivates old membership
- Sets appropriate status based on member history

## Best Practices

### For Developers

1. **Always use relations, never direct queries:**
   ```php
   // Good
   $user->rooms()->get();
   
   // Bad
   DB::table('members')->where('user_id', $userId)->get();
   ```

2. **Check status before operations:**
   ```php
   if ($room->isMember($userId)) {
       // User can access room
   }
   ```

3. **Use proper status transitions:**
   ```php
   // Don't manually set flags
   $member->update(['isMember' => false]); // âŒ
   
   // Use provided methods
   $this->removeMember($member, $room); // âœ…
   ```

4. **Always broadcast events for real-time updates:**
   ```php
   event(new RoomMemberRemovedEvent($slug, $username, $room_name));
   ```

### For UI Development

1. **Check all status flags:**
   ```javascript
   if (room.isRemoved) {
       // Show removal UI
   } else if (room.isNewRoom) {
       // Show invitation UI
   } else {
       // Show normal room UI
   }
   ```

2. **Update local state immediately:**
   ```javascript
   // Don't wait for server response to update UI
   room.isRemoved = true;
   updateRoomBadge(room.slug);
   ```

3. **Handle edge cases:**
   - Room not found in DOM (user on different page)
   - Event received before room list loaded
   - Multiple simultaneous status changes

## Troubleshooting

### Common Issues

**Room not disappearing after removal confirmation:**
- Check if `isMember` is in `$fillable` array
- Verify `leaveRoom()` sets both flags correctly
- Check `roomsIncludingRemoved()` filter

**Badge not appearing in real-time:**
- Verify WebSocket connection active
- Check event is broadcast to correct user
- Ensure `flagRoomUnreadMessages()` is available
- DOM element might not exist yet (use retry logic)

**Burger menu still showing for removed room:**
- Check `handleBurgerMenuClick()` early return
- Verify `createRoomItem()` hides button when `isRemoved=true`
- Check event listener hides button in real-time

**Re-invitation not working:**
- Verify `isOldMember()` finds the member record
- Check `recreateMembership()` sets both flags
- Ensure invitation system creates proper records

## Security Considerations

1. **Permission Checks:**
   - Only room admins can remove members
   - Users can only leave rooms they're members of
   - Invitation acceptance requires valid invitation record

2. **Data Validation:**
   - Validate user exists before operations
   - Verify room exists and is accessible
   - Check user has required permissions

3. **Audit Trail:**
   - Member records preserved (soft delete approach)
   - Timestamps track all changes
   - Event logs capture admin actions

## Future Enhancements

Potential improvements to consider:

1. **Advanced Permissions:**
   - Custom roles with granular permissions
   - Temporary bans with automatic expiry
   - Moderator role between admin and member

2. **Removal Reasons:**
   - Optional reason field for removals
   - Displayed to removed user
   - Helps with transparency

3. **Appeal System:**
   - Users can appeal removal
   - Admins review and decide
   - Automatic re-invitation on approval

4. **Bulk Operations:**
   - Remove multiple users at once
   - Export member list
   - Import invitations from CSV

5. **Analytics:**
   - Track member activity
   - Removal statistics
   - Re-invitation success rates
